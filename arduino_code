#include <Wire.h>
#include <LiquidCrystal_I2C.h>
#include <TinyGPS++.h>
#include <SoftwareSerial.h>

// Define the GPS serial connection
SoftwareSerial gpsSerial(6, 7); // RX, TX
static const uint32_t GPSBaud = 4800;

// Create an instance of the TinyGPS++ object
TinyGPSPlus gps;

// Create an instance of the LiquidCrystal_I2C object
LiquidCrystal_I2C lcd(0x20, 16, 2); // I2C address 0x20, 16 column and 2 rows

// Define the relay pin
const int relayPin = 9;

// Define the push button pin
const int buttonPin = 8;

// Define the target destination coordinates
const double targetLatitude = 37.7749; // Replace with your target latitude
const double targetLongitude = -122.4194; // Replace with your target longitude

// Define the distance threshold in meters (10 yards = 9.144 meters)
const double distanceThreshold = 9.144;

void setup() {
  // Initialize the serial communication
  Serial.begin(9600);
  gpsSerial.begin(9600);
  
  // Initialize the LCD
  lcd.init();
  lcd.backlight();
  
  // Initialize the relay pin
  pinMode(relayPin, OUTPUT);
  digitalWrite(relayPin, LOW);
  
  // Initialize the button pin
  pinMode(buttonPin, INPUT_PULLUP);
  
  // Display initial message
  lcd.clear();
  lcd.print("Press button");
  lcd.setCursor(0, 1);
  lcd.print("to start");
  delay(10000);
}

void loop() {
  // Check if the button is pressed
  if (digitalRead(buttonPin) == LOW) {
    // Process GPS data
    while (gpsSerial.available() > 0) {
      gps.encode(gpsSerial.read());
    }
    
    // Check if GPS data is valid
    if (gps.location.isValid()) {
      // Get the current coordinates
      double currentLatitude = gps.location.lat();
      double currentLongitude = gps.location.lng();
      
      // Calculate the distance to the target destination
      double distance = gps.distanceBetween(currentLatitude, currentLongitude, targetLatitude, targetLongitude);
      
      // Display the distance on the LCD
      lcd.clear();
      lcd.print("Distance:");
      lcd.setCursor(0, 1);
      lcd.print(distance);
      lcd.print(" m");
      
      // Check if the distance is within the threshold
      if (distance <= distanceThreshold) {
        // Open the latch
        digitalWrite(relayPin, HIGH);
        lcd.clear();
        lcd.print("UNLOCKED!!!");
      } else {
        // Keep the latch closed
        digitalWrite(relayPin, LOW);
      }
    } else {
      // Display GPS error message
      lcd.clear();
      lcd.print("GPS error");
    }
  } else {
    // Turn off the display if the button is not pressed
    lcd.clear();
    lcd.noBacklight();
  }
}
